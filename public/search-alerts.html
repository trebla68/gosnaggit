<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>GoSnaggit – Alerts</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<style>

        :root {
            --bg: #0b1020;
            --card-bg: #151a2b;
            --accent: #ffb347;
            --accent-strong: #ff9f1c;
            --text-main: #f7f7ff;
            --text-muted: #a2a7c4;
            --border-subtle: #262b3f;
            --radius-lg: 16px;
            --radius-xl: 22px;
            --danger: #ff4b5c;
            --ok: #33d17a;
            --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text-main);
            background:
                radial-gradient(1200px 700px at 15% 10%, rgba(255, 179, 71, 0.18), transparent 55%),
                radial-gradient(900px 600px at 80% 30%, rgba(255, 159, 28, 0.12), transparent 60%),
                var(--bg);
            min-height: 100vh;
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 22px 18px 40px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .logo-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand {
            font-weight: 800;
            letter-spacing: 0.4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-badge {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--accent);
            box-shadow: 0 0 0 5px rgba(255, 179, 71, 0.15);
        }

        .subhead {
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 2px;
        }

        .top-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-main);
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 650;
            font-size: 13px;
        }

        .btn:hover {
            border-color: rgba(255, 179, 71, 0.55);
        }

        .btn.primary {
            border-color: rgba(255, 179, 71, 0.55);
            background: rgba(255, 179, 71, 0.12);
        }

        .card {
            background: rgba(21, 26, 43, 0.92);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .card-h {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        
        .alerts-summary {
            margin: 14px 0 0 0;
        }

        .alerts-summary-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }


        .titleline {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 260px;
        }

        .h-title {
            font-size: 16px;
            font-weight: 800;
            margin: 0;
        }

        .h-meta {
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .flash {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 13px;
            display: none;
        }

        .flash.bad {
            display: block;
            border-color: rgba(255, 75, 92, 0.6);
            background: rgba(255, 75, 92, 0.10);
            color: #ffd7dd;
        }

        .flash.ok {
            display: block;
            border-color: rgba(51, 209, 122, 0.55);
            background: rgba(51, 209, 122, 0.10);
            color: #d8ffe9;
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 12px 16px 0;
        }

        .chip {
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
            font-size: 12px;
            font-weight: 750;
            padding: 7px 10px;
            border-radius: 999px;
            cursor: pointer;
            display: inline-flex;
            gap: 8px;
            align-items: center;
            user-select: none;
        }

        .chip:hover {
            border-color: rgba(255, 179, 71, 0.5);
        }

        .chip.active {
            border-color: rgba(255, 179, 71, 0.7);
            background: rgba(255, 179, 71, 0.12);
        }

        .chip .count {
            font-variant-numeric: tabular-nums;
            color: var(--text-muted);
            font-weight: 800;
        }

        .table-wrap {
            padding: 12px 16px 14px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 940px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead th {
            text-align: left;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 800;
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-subtle);
        }

        tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(38, 43, 63, 0.7);
            vertical-align: top;
            font-size: 13px;
            word-wrap: break-word;
        }

        tbody tr:hover td {
            background: rgba(255, 255, 255, 0.015);
        }

        .sub {
            display: block;
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            font-size: 12px;
            font-weight: 800;
            white-space: nowrap;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--text-muted);
            opacity: 0.95;
        }

        .pill.pending .dot {
            background: var(--accent);
        }

        .pill.sent .dot {
            background: var(--ok);
        }

        .pill.dismissed .dot {
            background: rgba(162, 167, 196, 0.9);
        }

        .pill.error .dot {
            background: var(--danger);
        }

        .mini {
            font-size: 12px;
            color: var(--text-muted);
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            border: 1px solid var(--border-subtle);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
            padding: 7px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 800;
        }

        .action-btn:hover {
            border-color: rgba(255, 179, 71, 0.55);
        }

        .action-btn.danger:hover {
            border-color: rgba(255, 75, 92, 0.7);
        }

        .action-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .pager {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 0 16px 14px;
            flex-wrap: wrap;
        }

        .pager .left,
        .pager .right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pager .label {
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 800;
        }

        .empty {
            padding: 14px 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
<link href="/app.css" rel="stylesheet"/><script defer="True" src="/ui.js"></script></head>
<body><header class="app-header" id="gs-header"></header>
<main class="gs-page">
<div class="page-actions">
<a class="btn btn-secondary" href="searches.html">← Saved Searches</a>
<a class="btn btn-primary" href="search-detail.html" id="backToDetail">Search Detail</a>
<button class="btn btn-secondary" id="refreshBtn" type="button">Refresh</button>
<button class="btn btn-primary" id="sendNowBtn" type="button">Send now</button>
</div>

<div class="wrap">
<div class="flash" id="flash"></div>
<div class="card">
<div class="card-h">
<div class="titleline">
<h2 class="h-title">Alerts for Search <span class="mono" id="searchId">—</span></h2>
<div class="h-meta">
<span id="summaryLine">Counts: —</span>
<span class="mini" id="rangeLine">Showing —</span>
</div>
</div>
<!-- ✅ Summary bar (must live INSIDE the card so it doesn't float/un-clickable) -->
<div class="alerts-summary" id="alerts-summary">
<div class="alerts-summary-row">
<div class="pill pending"><span class="dot"></span> Pending: <strong id="sum-pending">—</strong>
</div>
<div class="pill sent"><span class="dot"></span> Sent: <strong id="sum-sent">—</strong></div>
<div class="pill dismissed"><span class="dot"></span> Dismissed: <strong id="sum-dismissed">—</strong></div>
<div class="pill error"><span class="dot"></span> Error: <strong id="sum-error">—</strong></div>
</div>
</div>
</div>
<div class="chips" id="chips">
<!-- chips injected -->
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>ID</th>
<th>Status</th>
<th>Title</th>
<th>Price</th>
<th>Listing</th>
<th>Created</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tbody">
<!-- rows injected -->
</tbody>
</table>
<div class="empty" id="empty">No alerts found.</div>
</div>
<div class="pager">
<div class="left">
<button class="btn" id="prevBtn" type="button">← Prev</button>
<button class="btn" id="nextBtn" type="button">Next →</button>
</div>
<div class="right">
<span class="label" id="pageLabel">Page —</span>
<span class="label">Per page: <span class="mono" id="limitLabel">5</span></span>
</div>
</div>
</div>
</div>
<script>
        // -----------------------------------------
        // GoSnaggit Alerts UI Controller (TABLE + CHIPS)
        // Works with your existing HTML structure.
        // -----------------------------------------

        const qs = new URLSearchParams(window.location.search);
        const searchId = qs.get("search_id") || qs.get("id");
        if (!searchId) alert("Missing search_id in URL. Example: search-alerts.html?search_id=2");

        async function loadAlertsSummary() {
            try {
                const res = await fetch(`/api/searches/${encodeURIComponent(searchId)}/alerts/summary`);
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true) return;

                document.getElementById('sum-pending').textContent = data.counts?.pending ?? 0;
                document.getElementById('sum-sent').textContent = data.counts?.sent ?? 0;
                document.getElementById('sum-dismissed').textContent = data.counts?.dismissed ?? 0;
                document.getElementById('sum-error').textContent = data.counts?.error ?? 0;
            } catch (_) {
                // fail-soft
            }
        }


        // UI state
        let currentStatus = "pending"; // pending | sent | dismissed | error | all
        let limit = 5;                 // match your UI label default
        let offset = 0;                // pagination offset

        // Helpers
        function $(sel) { return document.querySelector(sel); }
        function esc(s) {
            return String(s ?? "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;");
        }

        function showFlash(kind, msg) {
            const el = $("#flash");
            if (!el) return;
            el.className = "flash" + (kind ? ` ${kind}` : "");
            el.textContent = msg || "";
            el.style.display = msg ? "block" : "none";
        }

        function setSubtitle() {
            const el = $("#subtitle");
            if (el) el.textContent = `Alerts (Search ${searchId})`;
            const sid = $("#searchId");
            if (sid) sid.textContent = searchId;
        }

        function buildAlertsUrl() {
            const base = `/api/searches/${searchId}/alerts?limit=${limit}&offset=${offset}`;
            if (currentStatus && currentStatus !== "all") return `${base}&status=${encodeURIComponent(currentStatus)}`;
            return base;
        }

        async function fetchJSON(url, options) {
            const res = await fetch(url, options);
            const text = await res.text();
            let data;
            try { data = JSON.parse(text); } catch { data = { raw: text }; }
            if (!res.ok) {
                const msg = data?.error || data?.message || `HTTP ${res.status}`;
                throw new Error(msg);
            }
            return data;
        }

        // ----------------------------
        // API calls
        // ----------------------------
        async function loadSummary() {
            return fetchJSON(`/api/searches/${searchId}/alerts/summary`);
        }

        async function loadAlerts() {
            const url = buildAlertsUrl();
            return fetchJSON(url);
        }

        async function patchAlertStatus(alertId, status) {
            return fetchJSON(`/api/alerts/${alertId}/status`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status })
            });
        }

        async function dispatchAlertsDev(sendLimit = 25) {
            return fetchJSON(`/dev/searches/${searchId}/dispatch-alerts?limit=${sendLimit}`);
        }

        // ----------------------------
        // Render chips + table
        // ----------------------------
        function renderChips(counts) {
            const chips = $("#chips");
            if (!chips) return;

            const pending = counts?.pending ?? 0;
            const sent = counts?.sent ?? 0;
            const dismissed = counts?.dismissed ?? 0;
            const error = counts?.error ?? 0;
            const total = counts?.total ?? (pending + sent + dismissed + error);

            const items = [
                { key: "pending", label: "Pending", count: pending },
                { key: "sent", label: "Sent", count: sent },
                { key: "dismissed", label: "Dismissed", count: dismissed },
                { key: "error", label: "Error", count: error },
                { key: "all", label: "All", count: total },
            ];

            chips.innerHTML = items.map(it => `
      <div class="chip ${it.key === currentStatus ? "active" : ""}" data-chip="${it.key}">
        ${esc(it.label)} <span class="count">(${it.count})</span>
      </div>
    `).join("");
        }

        function renderSummaryLine(counts) {
            const el = $("#summaryLine");
            if (!el) return;

            const p = counts?.pending ?? 0;
            const s = counts?.sent ?? 0;
            const d = counts?.dismissed ?? 0;
            const e = counts?.error ?? 0;
            const t = counts?.total ?? (p + s + d + e);

            el.textContent = `Counts: pending ${p} • sent ${s} • dismissed ${d} • error ${e} • total ${t}`;
        }

        function renderPagerLabel() {
            const pageLabel = $("#pageLabel");
            const limitLabel = $("#limitLabel");
            if (limitLabel) limitLabel.textContent = String(limit);

            const page = Math.floor(offset / limit) + 1;
            if (pageLabel) pageLabel.textContent = `Page ${page}`;
        }

        function pillClass(status) {
            const s = String(status || "").toLowerCase();
            if (s === "pending") return "pending";
            if (s === "sent") return "sent";
            if (s === "dismissed") return "dismissed";
            if (s === "error") return "error";
            return "";
        }

        function renderTable(rows) {
            const tbody = $("#tbody");
            const empty = $("#empty");
            if (!tbody) return;

            if (!Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = "";
                if (empty) empty.style.display = "block";
                if ($("#rangeLine")) $("#rangeLine").textContent = "Showing 0";
                return;
            }

            if (empty) empty.style.display = "none";
            if ($("#rangeLine")) $("#rangeLine").textContent = `Showing ${rows.length} (offset ${offset}, limit ${limit})`;

            tbody.innerHTML = rows.map(a => {
                const id = esc(a.alert_id);
                const status = String(a.status || "").toLowerCase();
                const statusPill = `
        <span class="pill ${pillClass(status)}">
          <span class="dot" aria-hidden="true"></span>${esc(status)}
        </span>
      `;

                const title = esc(a.title);
                const marketplace = esc(a.marketplace);
                const ext = esc(a.external_id);
                const price = esc(a.price);
                const currency = esc(a.currency);
                const url = esc(a.listing_url);
                const created = esc(a.alert_created_at);

                const toggleLabel = (status === "dismissed") ? "Reopen" : "Dismiss";
                const nextStatus = (status === "dismissed") ? "pending" : "dismissed";

                return `
        <tr data-alert-id="${id}">
          <td class="mono">${id}</td>
          <td>${statusPill}</td>
          <td>
            ${title}
            <span class="sub">(${marketplace}) <span class="mono">${ext}</span></span>
          </td>
          <td class="mono">${currency} ${price}</td>
          <td><a class="btn" style="padding:6px 10px; border-radius:10px;" href="${url}" target="_blank" rel="noopener">Open</a></td>
          <td class="mono">${created}</td>
          <td>
            <div class="actions">
              <button class="action-btn" data-action="toggle" data-next="${esc(nextStatus)}">${toggleLabel}</button>
            </div>
          </td>
        </tr>
      `;
            }).join("");
        }

        // ----------------------------
        // Main refresh
        // ----------------------------
        async function refreshAll() {
            showFlash("", "");
            renderPagerLabel();

            try {
                const summary = await loadSummary();
                const counts = summary?.counts || {};

                renderChips(counts);
                renderSummaryLine(counts);

                const rows = await loadAlerts();
                renderTable(rows);
            } catch (e) {
                showFlash("bad", e.message || String(e));
                renderTable([]); // show empty + avoid stale table
            }
        }

        // ----------------------------
        // Events
        // ----------------------------
        document.addEventListener("click", async (e) => {
            // chips
            const chip = e.target.closest("[data-chip]");
            if (chip) {
                currentStatus = chip.getAttribute("data-chip");
                offset = 0;
                await refreshAll();
                return;
            }

            // table actions
            const btn = e.target.closest("button[data-action]");
            if (btn) {
                const tr = e.target.closest("tr[data-alert-id]");
                const alertId = tr?.getAttribute("data-alert-id");
                if (!alertId) return;

                if (btn.dataset.action === "toggle") {
                    const next = btn.getAttribute("data-next");
                    try {
                        btn.disabled = true;
                        await patchAlertStatus(alertId, next);
                        showFlash("ok", `Updated alert ${alertId} → ${next}`);
                        await refreshAll();
                    } catch (err) {
                        showFlash("bad", err.message || String(err));
                    } finally {
                        btn.disabled = false;
                    }
                }
                return;
            }

            // refresh button
            const refreshBtn = e.target.closest("#refreshBtn");
            if (refreshBtn) {
                offset = 0;
                await refreshAll();
                return;
            }

            // send now button (dev)
            const sendNowBtn = e.target.closest("#sendNowBtn");
            if (sendNowBtn) {
                try {
                    sendNowBtn.disabled = true;
                    const result = await dispatchAlertsDev(25);
                    showFlash("ok", `Dispatch complete. sent=${result.sent} emailed=${result.emailed} error=${result.error}`);
                    await refreshAll();
                } catch (err) {
                    showFlash("bad", err.message || String(err));
                } finally {
                    sendNowBtn.disabled = false;
                }
                return;
            }

            // pager
            const prevBtn = e.target.closest("#prevBtn");
            if (prevBtn) {
                offset = Math.max(0, offset - limit);
                await refreshAll();
                return;
            }

            const nextBtn = e.target.closest("#nextBtn");
            if (nextBtn) {
                offset = offset + limit;
                await refreshAll();
                return;
            }
        });

        // Init
        setSubtitle();
        renderPagerLabel();
        refreshAll();
        loadAlertsSummary();

</script>
</main>
</body>
</html>