<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>GoSnaggit – Search Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --card-bg: #151a2b;
      --accent: #ffb347;
      --accent-soft: rgba(255, 179, 71, 0.15);
      --accent-strong: #ff9f1c;
      --text-main: #f7f7ff;
      --text-muted: #a2a7c4;
      --border-subtle: #262b3f;
      --radius-lg: 16px;
      --radius-xl: 22px;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at top left, #1d2440 0, #050712 55%, #020308 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      border-radius: var(--radius-xl);
      background: linear-gradient(135deg, rgba(255, 179, 71, 0.07), rgba(93, 63, 211, 0.2));
      padding: 2px;
      box-shadow: var(--shadow-soft);
    }

    .inner {
      border-radius: calc(var(--radius-xl) - 2px);
      background: radial-gradient(circle at top right, #222742 0, #101425 55%, #050712 100%);
      padding: 22px 22px 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 2.1fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .inner {
        grid-template-columns: minmax(0, 1fr);
        padding: 20px 16px 18px;
      }
    }

    header {
      margin-bottom: 1rem;
    }

    .logo-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 10px;
    }

    .logo-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #ffe8c2, #ffb347 36%, #ff9f1c 72%, #f75c03);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1b1206;
      font-weight: 800;
      font-size: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.55);
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-text span:first-child {
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .logo-text span:last-child {
      font-size: 0.98rem;
      font-weight: 600;
    }

    .nav-links {
      display: flex;
      gap: 0.6rem;
      font-size: 0.8rem;
    }

    .nav-links a {
      color: var(--text-muted);
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
    }

    .nav-links a:hover {
      color: var(--text-main);
      border-color: rgba(255, 179, 71, 0.35);
      background-color: rgba(255, 179, 71, 0.10);
    }


    h1 {
      font-size: clamp(1.45rem, 1.9vw + 0.9rem, 2rem);
      margin: 0 0 0.35rem;
      line-height: 1.2;
    }

    .empty-state {
      font-size: 0.86rem;
      color: var(--text-muted);
      padding: 12px 4px;
      line-height: 1.45;
    }

    .empty-state strong {
      color: var(--text-main);
      font-weight: 600;
    }

    .empty-state a {
      color: var(--accent);
      text-decoration: none;
    }

    .empty-state a:hover {
      text-decoration: underline;
    }


    .subtitle strong {
      color: var(--accent);
      font-weight: 600;
    }

    .info-card {
      margin-top: 1.1rem;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, var(--card-bg), #0d1021 60%);
      border: 1px solid rgba(80, 97, 183, 0.6);
      padding: 12px 13px 10px;
      font-size: 0.82rem;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 0.35rem;
    }

    .info-label {
      color: var(--text-muted);
    }

    .info-value {
      font-weight: 500;
    }

    .info-pills {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .info-pill {
      border-radius: 999px;
      padding: 3px 8px;
      background-color: rgba(8, 10, 25, 0.95);
      border: 1px solid rgba(52, 64, 132, 0.85);
      color: var(--text-muted);
      font-size: 0.76rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      background-color: rgba(94, 234, 212, 0.13);
      border-color: rgba(34, 197, 154, 0.6);
      color: #a7ffeb;
    }

    /* Right: results grid */
    .results-card {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, var(--card-bg), #0d1021 60%);
      border: 1px solid rgba(80, 97, 183, 0.6);
      padding: 14px 13px 12px;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .results-title {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .results-meta {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .results-controls {
      display: flex;
      gap: 0.4rem;
      font-size: 0.78rem;
    }

    .tiny-pill {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: var(--text-muted);
      cursor: default;
    }

    .refresh-btn {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--accent);
      background-color: transparent;
      font-size: 0.78rem;
      cursor: pointer;
    }

    .refresh-btn:hover {
      background-color: rgba(12, 16, 36, 0.92);
      border-color: rgba(255, 179, 71, 0.45);
    }

    .grid-wrapper {
      margin-top: 0.4rem;
      border-radius: 10px;
      border: 1px solid rgba(46, 57, 118, 0.9);
      background-color: rgba(6, 8, 22, 0.96);
      padding: 10px;
      max-height: 440px;
      overflow: auto;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 10px;
    }

    .result-card {
      border-radius: 10px;
      background: radial-gradient(circle at top left, #151827, #050712 70%);
      border: 1px solid rgba(46, 57, 118, 0.9);
      padding: 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.8rem;
    }

    .result-header {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .result-source {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .result-price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.86rem;
    }

    .price-pill {
      border-radius: 999px;
      padding: 3px 9px;
      background-color: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      font-size: 0.8rem;
    }

    .condition-pill {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      color: #e2e8f0;
      font-size: 0.75rem;
    }

    .result-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .result-link {
      font-size: 0.78rem;
      text-decoration: none;
      color: var(--accent);
    }

    .result-link:hover {
      text-decoration: underline;
    }

    .empty-state {
      font-size: 0.86rem;
      color: var(--text-muted);
      padding: 10px 4px;
    }

    .pagination {
      margin-top: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .pagination-controls {
      display: flex;
      gap: 0.4rem;
    }

    .page-btn {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background-color: transparent;
      color: #e2e8f0;
      font-size: 0.78rem;
      cursor: pointer;
    }

    .page-btn[disabled] {
      opacity: 0.4;
      cursor: default;
    }

    #message {
      margin-top: 0.6rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .message-error {
      color: #ffc5cb;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="inner">
      <!-- Left: search context/info -->
      <div>
        <header>
          <div class="logo-row">
            <div class="logo-left">
              <div class="logo-mark">G</div>
              <div class="logo-text">
                <span>GoSnaggit</span>
                <span>Results for this hunt</span>
              </div>
            </div>
            <nav class="nav-links">
              <a href="/index.html">Home</a>
              <a href="/searches.html">Saved searches</a>
            </nav>
          </div>
          <h1 id="search-title">Search results</h1>
          <p class="subtitle" id="search-subtitle">
            Viewing mock marketplace results for this saved search.
          </p>
        </header>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Item</span>
            <span class="info-value" id="info-item">—</span>
          </div>
          <div class="info-row">
            <span class="info-label">Location</span>
            <span class="info-value" id="info-location">—</span>
          </div>
          <div class="info-row">
            <span class="info-label">Category</span>
            <span class="info-value" id="info-category">—</span>
          </div>
          <div class="info-row">
            <span class="info-label">Max price</span>
            <span class="info-value" id="info-max-price">—</span>
          </div>

          <div class="info-pills">
            <span class="info-pill" id="info-status-pill">Status: —</span>
            <span class="info-pill" id="info-count-pill">Results: —</span>
          </div>
        </div>
      </div>

      <!-- Right: results panel -->
      <div class="results-card">
        <div class="results-header">
          <div>
            <div class="results-title">Results preview</div>
            <div class="results-meta" id="results-meta">
              Loading…
            </div>
          </div>
          <div class="results-controls">
            <button type="button" class="refresh-btn" id="refresh-button">Refresh</button>
          </div>
        </div>

        <div class="grid-wrapper">
          <div id="results-grid" class="results-grid">
            <!-- cards go here -->
          </div>
          <div id="empty-state" class="empty-state" style="display:none;">
            <strong>No results yet.</strong><br>
            This hunt is set up — results will appear here as sources are checked.
            Try <a href="#" id="empty-refresh">Refresh</a> or go back to
            <a href="/searches.html">Saved searches</a>.
          </div>

        </div>

        <div class="pagination">
          <div id="page-summary">Page 1 of 1</div>
          <div class="pagination-controls">
            <button type="button" class="page-btn" id="prev-page">Previous</button>
            <button type="button" class="page-btn" id="next-page">Next</button>
          </div>
        </div>

        <div id="message"></div>
      </div>
    </div>
  </div>

  <script>
    function getParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        search_id: params.get('search_id'),
        page: parseInt(params.get('page') || '1', 10)
      };
    }


    const { search_id: searchId, page: initialPage } = getParams();


    const searchTitleEl = document.getElementById('search-title');
    const searchSubtitleEl = document.getElementById('search-subtitle');
    const infoItemEl = document.getElementById('info-item');
    const infoLocationEl = document.getElementById('info-location');
    const infoCategoryEl = document.getElementById('info-category');
    const infoMaxPriceEl = document.getElementById('info-max-price');
    const infoStatusPill = document.getElementById('info-status-pill');
    const infoCountPill = document.getElementById('info-count-pill');

    const resultsGrid = document.getElementById('results-grid');
    const emptyStateEl = document.getElementById('empty-state');
    const resultsMetaEl = document.getElementById('results-meta');
    const pageSummaryEl = document.getElementById('page-summary');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const refreshBtn = document.getElementById('refresh-button');
    const messageEl = document.getElementById('message');

    let currentPage = initialPage || 1;
    const limitPerPage = 6;
    let totalPages = 1;
    let totalResults = 0;

    if (!searchId) {
      resultsMetaEl.textContent = 'No search selected.';
      messageEl.textContent = 'Open results from Saved searches (or add ?id=1 to the URL).';
      messageEl.className = 'message-error';

      // Hide the grid and show a helpful empty state
      resultsGrid.innerHTML = '';
      emptyStateEl.style.display = 'block';

      // Disable controls that won’t work without an id
      prevPageBtn.disabled = true;
      nextPageBtn.disabled = true;
      refreshBtn.disabled = true;

      // Adjust empty-state links for this scenario
      const emptyRefresh = document.getElementById('empty-refresh');
      if (emptyRefresh) emptyRefresh.style.display = 'none';
    } else {
      loadSearchContext();
      loadResults();
    }


    // Load basic info about the search itself for the left panel
    function loadSearchContext() {
      fetch('/searches/' + searchId)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to load search details');
          }
          return response.json();
        })
        .then(data => {
          const item = data.search_item || 'Saved search';
          searchTitleEl.textContent = item;
          searchSubtitleEl.textContent = 'Viewing results for this saved search.';
          infoItemEl.textContent = item;
          infoLocationEl.textContent = data.location || '—';
          infoCategoryEl.textContent = data.category || '—';
          infoMaxPriceEl.textContent = data.max_price ? '$' + data.max_price : '—';

          const status = (data.status || '—').toLowerCase();
          infoStatusPill.textContent = 'Status: ' + (data.status || '—');
        })
        .catch(err => {
          resultsMetaEl.textContent = 'Error loading search details: ' + err.message;
        });
    }
    // Load stored marketplace results for this search (paginated)
    function loadResults() {
      if (!searchId) return;

      resultsMetaEl.textContent = 'Loading results…';
      messageEl.textContent = '';
      messageEl.className = '';

      const offset = (currentPage - 1) * limitPerPage;

      fetch(`/searches/${searchId}/results?limit=${limitPerPage}&offset=${offset}`)
        .then(response => {
          if (!response.ok) {
            if (response.status === 404) {
              return [];
            }
            throw new Error('Failed to load results');
          }
          return response.json(); // now expects an ARRAY
        })
        .then(results => {
          // Ensure array
          results = Array.isArray(results) ? results : [];

          // We don’t yet know totalResults/totalPages from the backend.
          // For now, we can infer pagination like this:
          // - If we got fewer than limitPerPage results, we’re likely on the last page.
          // - Next button enabled only when we got a "full page" worth of results.
          const gotFullPage = results.length === limitPerPage;

          // Display counts based on what we know (this page only)
          infoCountPill.textContent = `Results: ${results.length}${gotFullPage ? '+' : ''}`;
          resultsMetaEl.textContent = results.length
            ? `Showing ${results.length} result(s) (page ${currentPage}).`
            : 'No results yet — this hunt is ready and will populate as sources are checked.';

          resultsGrid.innerHTML = '';

          if (results.length === 0) {
            emptyStateEl.style.display = 'block';

            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = true;
          } else {
            emptyStateEl.style.display = 'none';

            results.forEach(r => {
              const card = document.createElement('div');
              card.className = 'result-card';

              const title = r.title || 'Listing';
              const source = r.marketplace || 'Marketplace';

              const price =
                r.price != null
                  ? `${r.currency ? r.currency + ' ' : '$'}${Number(r.price).toFixed(2)}`
                  : '—';

              const condition = r.condition || 'Unknown';
              const location = r.location || 'Online';
              const postedAt = r.found_at
                ? new Date(r.found_at).toLocaleDateString()
                : '—';

              const url = r.listing_url || '#';

              card.innerHTML = `
            <div class="result-header">${title}</div>
            <div class="result-source">${source}</div>
            <div class="result-price-row">
              <span class="price-pill">${price}</span>
              <span class="condition-pill">${condition}</span>
            </div>
            <div class="result-footer">
              <span>${location} • ${postedAt}</span>
              <a href="${url}" target="_blank" rel="noopener noreferrer" class="result-link">View listing</a>
            </div>
          `;

              resultsGrid.appendChild(card);
            });

            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = !gotFullPage;
          }

          // Update the simple page indicator
          pageSummaryEl.textContent = `Page ${currentPage}`;
        })
        .catch(err => {
          resultsGrid.innerHTML = '';
          emptyStateEl.style.display = 'block';

          resultsMetaEl.textContent = 'Results aren’t available right now.';
          messageEl.textContent =
            'Tip: if this search was deleted or the server was restarted, go back to Saved searches and open Results again.';
          messageEl.className = 'message-error';

          prevPageBtn.disabled = true;
          nextPageBtn.disabled = true;
        });
    }


    function updatePagination() {
      pageSummaryEl.textContent = `Page ${currentPage} of ${totalPages}`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    prevPageBtn.addEventListener('click', function () {
      if (prevPageBtn.disabled) return;

      currentPage -= 1;
      loadResults();
      updateUrl();
    });


    nextPageBtn.addEventListener('click', function () {
      if (nextPageBtn.disabled) return;

      currentPage += 1;
      loadResults();
      updateUrl();
    });


    refreshBtn.addEventListener('click', function () {
      loadResults();
    });
    document.addEventListener('click', function (e) {
      if (e.target && e.target.id === 'empty-refresh') {
        e.preventDefault();
        loadResults();
      }
    });

    function updateUrl() {
      const params = new URLSearchParams(window.location.search);
      params.set('search_id', searchId);
      params.set('page', String(currentPage));
      const newUrl = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newUrl);
    }

  </script>
</body>

</html>